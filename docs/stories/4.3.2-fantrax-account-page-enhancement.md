# Story 4.3.2: Fantrax Account Page Enhancement with In-Browser Authentication

**Epic:** 4.3 Fantrax League Integration
**Story Type:** Feature Enhancement (Brownfield)
**Priority:** High
**Estimated Effort:** 14-18 hours
**Sprint:** TBD

---

## User Story

**As a** premium dynasty fantasy player using Fantrax,
**I want** to connect my Fantrax account directly from my account page with seamless in-browser authentication,
**So that** I can easily manage my league connections, sync rosters, and access personalized recommendations without technical friction.

---

## Context & Background

### Current State
- Backend Fantrax integration exists with cookie-based authentication
- Current implementation requires users to upload cookie files (technical friction)
- FantraxConnection component exists but isn't integrated into account management
- No dedicated account hub page - features scattered across multiple pages
- Existing `/account/subscription` page getting cluttered

### Problem Statement
Users face significant friction connecting Fantrax accounts due to:
1. Technical requirement to run Python scripts locally
2. Manual cookie file upload process
3. No centralized account management interface
4. Confusing user flow for league management

### Proposed Solution
Create a unified account hub with dedicated Fantrax integration tab featuring:
1. **In-browser authentication** - Server-side Selenium with real-time progress
2. **Multi-league management** - Switch between multiple connected leagues
3. **Manual sync controls** - User-initiated roster updates
4. **Clean account structure** - Profile | Subscription | Fantrax | Preferences tabs

---

## Acceptance Criteria

### 1. Unified Account Page Structure
- [ ] Create new `/app/account/page.tsx` as main account hub
- [ ] Implement tab navigation with 4 tabs:
  - Profile (personal info, email, password)
  - Subscription (billing, plan management)
  - Fantrax (league integration)
  - Preferences (settings, notifications)
- [ ] Migrate existing subscription functionality to Subscription tab
- [ ] Maintain URL persistence for tab selection (`/account?tab=fantrax`)
- [ ] Mobile-responsive tab navigation

### 2. In-Browser Fantrax Authentication (Backend)
- [ ] Create `/api/fantrax/auth/initiate` endpoint
  - Spawns server-side headless Chrome browser
  - Returns session ID for tracking
  - Navigates to Fantrax login page
- [ ] Create `/api/fantrax/auth/status` endpoint
  - Polls Selenium browser state
  - Returns current URL and authentication status
  - Supports WebSocket for real-time updates (optional)
- [ ] Create `/api/fantrax/auth/complete` endpoint
  - Captures cookies after successful login
  - Encrypts and stores in database
  - Cleans up Selenium session
- [ ] Implement session isolation (multiple concurrent users)
- [ ] Add 90-second timeout for auth flow
- [ ] Handle browser cleanup on timeout/failure
- [ ] Add rate limiting (1 auth attempt per user every 30 seconds)

### 3. In-Browser Authentication UI (Frontend)
- [ ] "Connect Fantrax" button initiates auth flow
- [ ] Display embedded browser preview (iframe or modal)
  - Show Fantrax login page
  - Real-time status updates ("Loading...", "Ready to login", "Authenticating...")
- [ ] Progress indicator with clear steps:
  1. Initializing browser...
  2. Please log in to Fantrax
  3. Capturing authentication...
  4. Connected!
- [ ] Handle authentication states:
  - Loading (initializing Selenium)
  - Ready (browser opened, waiting for user login)
  - Authenticating (detecting login completion)
  - Success (cookies captured)
  - Error (timeout, failed login, technical error)
- [ ] Clear error messages with retry options
- [ ] "Cancel" button to abort authentication

### 4. Fantrax Integration Tab
- [ ] **Connection Status Section**
  - Display connected/disconnected state
  - Show connection timestamp ("Connected 2 hours ago")
  - "Disconnect" button to remove Fantrax connection
  - Connection benefits list when disconnected
- [ ] **League Management Section** (only when connected)
  - Multi-league dropdown selector
  - Display league name, format, and team name
  - "Sync Roster" button per league (manual only)
  - Last sync timestamp per league
  - Sync status indicator (syncing/idle/error)
- [ ] **Roster Display** (when league selected and synced)
  - Player list with: name, position, team, status
  - Position filter (All/Hitters/Pitchers)
  - Sort options (name, position, team)
  - Empty state when no roster data
- [ ] **League Settings Display**
  - Roster size and positions
  - Scoring categories
  - Trade deadline information
- [ ] Premium feature gate (entire Fantrax tab premium-only)

### 5. API Integration
- [ ] Connect to existing `/api/fantrax-v2/leagues` endpoint
- [ ] Connect to existing `/api/fantrax-v2/roster/{league_id}` endpoint
- [ ] Add new auth endpoints to `useFantrax` hook
- [ ] Implement polling mechanism for auth status (every 2 seconds)
- [ ] Handle cookie expiration gracefully
- [ ] Loading states for all async operations:
  - Connection (30-90 seconds for Selenium)
  - League fetch (2-5 seconds)
  - Roster sync (5-10 seconds)
- [ ] Error handling with user-friendly messages

### 6. Data & State Management
- [ ] Store selected league in local storage
- [ ] Persist Fantrax connection state across page loads
- [ ] Clear Fantrax data on disconnect
- [ ] Handle multiple leagues in dropdown state
- [ ] Show sync progress for roster updates

### 7. Mobile Responsiveness
- [ ] Tab navigation adapts to mobile (dropdown or horizontal scroll)
- [ ] Auth modal full-screen on mobile
- [ ] Roster table responsive (card view on mobile)
- [ ] Touch-friendly sync buttons

### 8. Security & Performance
- [ ] Premium-only access enforcement for Fantrax tab
- [ ] Encrypted cookie storage (already implemented in backend)
- [ ] Rate limiting on auth endpoint (backend)
- [ ] Selenium session cleanup (prevent memory leaks)
- [ ] Browser timeout handling (90 seconds max)
- [ ] XSS protection for user-generated content
- [ ] CORS configuration for auth iframe (if used)

---

## Technical Architecture

### Backend Changes

#### New Endpoints
```python
# apps/api/app/api/api_v1/endpoints/fantrax_auth.py

POST /api/fantrax/auth/initiate
- Creates Selenium session
- Returns: { session_id, status_url }

GET /api/fantrax/auth/status/{session_id}
- Polls browser state
- Returns: { status: "ready|authenticating|success|failed", current_url }

POST /api/fantrax/auth/complete/{session_id}
- Captures cookies
- Stores encrypted in DB
- Returns: { success, user_id, leagues_count }

DELETE /api/fantrax/auth/cancel/{session_id}
- Cleanup browser session
```

#### Modified Services
```python
# apps/api/app/services/fantrax_cookie_service.py

class FantraxCookieService:
    async def create_auth_session(user_id: int) -> str
    async def get_session_status(session_id: str) -> dict
    async def complete_auth(session_id: str) -> bool
    async def cleanup_session(session_id: str) -> None
```

#### Database Schema (No changes needed)
- Existing `users.fantrax_cookies` field (encrypted)
- Existing `users.fantrax_connected_at` timestamp

---

### Frontend Changes

#### New Pages
```typescript
// apps/web/src/app/account/page.tsx
- Main account hub with tab navigation
- Tab routing with query params
- Premium access check

// apps/web/src/app/account/layout.tsx (optional)
- Shared layout for account pages
```

#### New Components
```typescript
// apps/web/src/components/account/AccountTabs.tsx
- Tab navigation component
- Active tab state management

// apps/web/src/components/account/ProfileTab.tsx
- User profile management

// apps/web/src/components/account/SubscriptionTab.tsx
- Migrated from existing subscription page

// apps/web/src/components/account/FantraxTab.tsx
- Main Fantrax integration UI
- Connection, league selection, roster display

// apps/web/src/components/account/PreferencesTab.tsx
- User preferences and settings

// apps/web/src/components/integrations/FantraxAuthModal.tsx
- In-browser authentication flow
- Progress indicators
- Error handling
```

#### Modified Components
```typescript
// apps/web/src/components/integrations/FantraxConnection.tsx
- Update to use new auth endpoints
- Remove file upload logic

// apps/web/src/components/integrations/LeagueSelector.tsx
- Add multi-league dropdown
- Integrate with FantraxTab
```

#### Modified Hooks
```typescript
// apps/web/src/hooks/useFantrax.ts
- Add auth session management
- Add polling mechanism for auth status
- Add manual sync functions
```

---

## Dependencies

### Existing Code to Leverage
- [x] `FantraxConnection` component (modify)
- [x] `LeagueSelector` component (integrate)
- [x] `useFantrax` hook (extend)
- [x] Fantrax API service layer (backend)
- [x] Cookie encryption service (backend)
- [x] Premium user authentication

### External Dependencies
- Selenium WebDriver (already installed)
- Chrome/Chromium browser (already configured)
- WebDriver Manager (already installed)

---

## Testing Requirements

### Unit Tests
- [ ] Backend auth session management
- [ ] Cookie encryption/decryption
- [ ] Frontend tab navigation
- [ ] useFantrax hook state management
- [ ] Component rendering (ProfileTab, FantraxTab, etc.)

### Integration Tests
- [ ] Full auth flow (initiate → status → complete)
- [ ] League selection and roster sync
- [ ] Premium access enforcement
- [ ] Multi-league switching
- [ ] Error handling and timeout scenarios

### E2E Tests
- [ ] Complete user flow: Login → Account → Connect Fantrax → Select League → Sync Roster
- [ ] Authentication timeout handling
- [ ] Disconnect and reconnect flow
- [ ] Mobile responsive testing

### Security Tests
- [ ] Cookie encryption verification
- [ ] Premium access enforcement
- [ ] Rate limiting on auth endpoints
- [ ] XSS protection

---

## Non-Functional Requirements

### Performance
- [ ] Account page initial load < 2 seconds
- [ ] Tab switching < 300ms
- [ ] Auth initialization < 5 seconds
- [ ] Selenium browser ready < 15 seconds
- [ ] Total auth flow < 90 seconds
- [ ] League list load < 3 seconds
- [ ] Roster sync < 10 seconds

### Security
- [ ] All Fantrax cookies encrypted at rest (AES-256)
- [ ] Secure session management (no session hijacking)
- [ ] Rate limiting prevents brute force
- [ ] Premium-only enforcement server-side

### Usability
- [ ] Clear progress indicators for all async operations
- [ ] Error messages actionable and user-friendly
- [ ] Mobile-optimized interface
- [ ] Accessible (WCAG 2.1 AA)

### Reliability
- [ ] Selenium cleanup on all exit paths (success/failure/timeout)
- [ ] Graceful degradation if Selenium unavailable
- [ ] Cookie expiration handling
- [ ] Retry mechanism for transient failures

---

## User Flow Diagram

```
User on App
    ↓
Navigate to /account
    ↓
[Profile | Subscription | Fantrax | Preferences] Tabs
    ↓
Click "Fantrax" Tab
    ↓
Premium Check → [FAIL] → Upgrade Prompt
    ↓ [PASS]
Connection Status: Disconnected
    ↓
Click "Connect Fantrax"
    ↓
Auth Modal Opens
    ↓
Backend: Selenium Initializing... (5-15s)
    ↓
Backend: Browser Ready
    ↓
User: Logs in to Fantrax (in modal)
    ↓
Backend: Detecting login... (2-5s)
    ↓
Backend: Capturing cookies...
    ↓
[SUCCESS] → Modal closes → "Connected!" message
    ↓
Fetch Leagues → Display League Dropdown
    ↓
User: Selects League
    ↓
User: Clicks "Sync Roster"
    ↓
Display: Syncing... (5-10s)
    ↓
Display: Roster Table with Players
    ↓
User: Views roster, league settings
```

---

## Definition of Done

- [ ] All acceptance criteria met and verified
- [ ] Unit tests written and passing (>80% coverage)
- [ ] Integration tests passing
- [ ] E2E test covering main user flow
- [ ] Code reviewed by peer
- [ ] Security review completed (cookie handling, auth flow)
- [ ] Performance benchmarks met
- [ ] Mobile responsive testing completed
- [ ] Documentation updated:
  - API endpoint documentation
  - Component documentation
  - User guide for Fantrax connection
- [ ] QA testing completed
- [ ] Product Owner acceptance
- [ ] Deployed to staging and verified
- [ ] Monitoring/logging in place for auth failures

---

## Risks & Mitigations

### High Risk: Selenium Session Management
**Risk:** Memory leaks, orphaned browser processes
**Mitigation:**
- Strict timeout enforcement (90s)
- Automatic cleanup on all exit paths
- Session tracking and monitoring
- Add health check endpoint

### Medium Risk: Authentication Timeout
**Risk:** Users get frustrated with long wait times
**Mitigation:**
- Clear progress indicators
- Show expected time ranges
- "Cancel" button always available
- Help text about normal delays

### Medium Risk: Concurrent Auth Sessions
**Risk:** Server resource exhaustion with multiple simultaneous auth attempts
**Mitigation:**
- Rate limiting (1 per user per 30s)
- Max concurrent sessions (10 globally)
- Queue system for excess requests

### Low Risk: Cookie Expiration
**Risk:** Stored cookies expire, breaking league sync
**Mitigation:**
- Detect 401/403 responses
- Prompt user to re-authenticate
- Show "Last connected X days ago"

---

## Open Questions

1. **WebSocket vs Polling?** - For real-time auth status updates
   - **Recommendation:** Start with polling (simpler), add WebSocket if needed

2. **Browser Display?** - Show actual browser to user or just status?
   - **Recommendation:** Status indicators only (simpler, more secure)

3. **Multi-League Limit?** - Cap number of connected leagues?
   - **Recommendation:** No limit for premium users

4. **Auto-sync future?** - User mentioned manual only, but keep door open?
   - **Recommendation:** Build with extensibility for future auto-sync

---

## Success Metrics

### Adoption Metrics
- 30% of premium users connect Fantrax within 30 days
- 70% auth success rate (excluding user abandonment)
- Average auth completion time < 60 seconds

### Engagement Metrics
- 60% of connected users sync roster weekly
- 40% of users connect multiple leagues
- Average 3 league switches per session

### Quality Metrics
- < 5% auth failure rate (technical errors)
- < 2% Selenium timeout rate
- Zero security incidents

---

## Implementation Notes

### Development Order (Recommended)
1. **Backend Auth Endpoints** (4-6 hours)
   - Selenium session management
   - Status polling
   - Cookie capture
2. **Account Page Structure** (2-3 hours)
   - Tab navigation
   - Migrate subscription page
3. **Fantrax Auth UI** (3-4 hours)
   - Modal with progress
   - Status polling
4. **League Management** (2-3 hours)
   - Multi-league dropdown
   - Sync controls
5. **Roster Display** (2-3 hours)
   - Table/grid layout
   - Filters and sorting
6. **Testing & Polish** (2-3 hours)

**Total Estimated: 15-22 hours**

---

## Related Stories
- Story 4.3: Fantrax League Integration (Parent Epic)
- Story 4.1: Subscription Management System (Prerequisite)
- Story 4.4: Personalized Recommendation Engine (Dependent)

---

## Notes
- This is a brownfield enhancement leveraging existing backend infrastructure
- Focus on UX improvements (in-browser auth vs file upload)
- Architectural decision to use manual sync keeps scope manageable
- Multi-league support sets foundation for recommendation engine (4.4)

---

**Status:** DRAFT
**Created:** 2025-10-14
**Last Updated:** 2025-10-14
**Story Points:** 13 (Large)
