# Story 4.5: User Engagement and Retention Features

## Status
Draft

## Story

**As a** platform operator,
**I want** features that increase user engagement and reduce churn,
**so that** the business can achieve sustainable growth and retention targets.

## Acceptance Criteria

1. User onboarding flow with feature education and value demonstration
2. Prospect watchlist functionality with change tracking and alerts
3. Weekly email digest with personalized prospect updates and recommendations
4. Achievement system recognizing user engagement milestones
5. Referral program with rewards for successful user acquisitions
6. User feedback collection system for feature prioritization and satisfaction monitoring
7. Usage analytics tracking for feature adoption and user behavior insights
8. Churn prediction modeling with proactive retention interventions

## Tasks / Subtasks

- [ ] Task 1: Build User Onboarding Flow (AC: 1)
  - [ ] Create OnboardingService for managing onboarding state and progress
  - [ ] Implement multi-step onboarding wizard with feature education screens
  - [ ] Add OnboardingWizard component with progress tracking
  - [ ] Create interactive feature demonstrations (rankings, comparisons, AI outlooks)
  - [ ] Implement onboarding completion tracking in user preferences
  - [ ] Add skip/resume onboarding functionality
  - [ ] Store onboarding_completed and onboarding_step in users table
  - [ ] Write tests for onboarding flow progression

- [ ] Task 2: Implement Prospect Watchlist System (AC: 2)
  - [ ] Create watchlists table in database (user_id, prospect_id, added_at, notes)
  - [ ] Build WatchlistService for managing user watchlists
  - [ ] Add API endpoints for watchlist CRUD operations (/api/watchlist)
  - [ ] Implement change tracking for watched prospects (stat changes, rank changes)
  - [ ] Create WatchlistCard and WatchlistDashboard components
  - [ ] Add notification system for significant watchlist prospect changes
  - [ ] Implement watchlist export functionality
  - [ ] Write tests for watchlist operations and change detection

- [ ] Task 3: Develop Weekly Email Digest System (AC: 3)
  - [ ] Create email_preferences table (user_id, digest_enabled, frequency, last_sent)
  - [ ] Build EmailDigestService for generating personalized content
  - [ ] Integrate email provider (evaluation needed - Resend, SendGrid, or AWS SES)
  - [ ] Implement digest content generator (watchlist updates, top movers, recommendations)
  - [ ] Create email templates with responsive HTML design
  - [ ] Add scheduled job for weekly digest generation (background task)
  - [ ] Implement email preference management UI
  - [ ] Add unsubscribe functionality with preference granularity
  - [ ] Test email rendering across multiple clients

- [ ] Task 4: Build Achievement System (AC: 4)
  - [ ] Create achievements table (id, name, description, criteria, icon, points)
  - [ ] Create user_achievements table (user_id, achievement_id, unlocked_at)
  - [ ] Build AchievementService for tracking and unlocking achievements
  - [ ] Define achievement criteria (first login, 10 comparisons, watchlist milestone, etc.)
  - [ ] Implement achievement unlock detection system
  - [ ] Create AchievementBadge and AchievementsList components
  - [ ] Add achievement notification system (toast/modal on unlock)
  - [ ] Implement user achievement profile page
  - [ ] Write tests for achievement unlock logic

- [ ] Task 5: Create Referral Program System (AC: 5)
  - [ ] Create referral_codes table (user_id, code, created_at, uses_remaining)
  - [ ] Create referrals table (referrer_id, referred_user_id, status, reward_granted)
  - [ ] Build ReferralService for code generation and tracking
  - [ ] Implement referral code validation during registration
  - [ ] Add referral reward system (free premium month, extended features)
  - [ ] Create ReferralDashboard component showing stats and rewards
  - [ ] Add referral link sharing functionality (social media, email, copy link)
  - [ ] Implement reward fulfillment automation
  - [ ] Write tests for referral tracking and rewards

- [ ] Task 6: Implement User Feedback Collection System (AC: 6)
  - [ ] Create feedback table (user_id, type, rating, message, feature_request, submitted_at)
  - [ ] Build FeedbackService for collecting and categorizing feedback
  - [ ] Add API endpoints for feedback submission (/api/feedback)
  - [ ] Create FeedbackModal component with rating and comment fields
  - [ ] Implement in-app feedback triggers (feature usage, time-based prompts)
  - [ ] Add NPS (Net Promoter Score) survey system
  - [ ] Create admin dashboard for reviewing feedback (future enhancement marker)
  - [ ] Implement feedback acknowledgment notifications
  - [ ] Write tests for feedback collection and storage

- [ ] Task 7: Build Usage Analytics Tracking System (AC: 7)
  - [ ] Create analytics_events table (user_id, event_name, event_data JSONB, timestamp)
  - [ ] Build AnalyticsService for event tracking and aggregation
  - [ ] Implement frontend analytics hook (useAnalytics) for event capture
  - [ ] Add key event tracking (page views, feature usage, searches, comparisons)
  - [ ] Create analytics aggregation queries for feature adoption metrics
  - [ ] Implement user activity timeline for engagement analysis
  - [ ] Add privacy-compliant analytics with user consent management
  - [ ] Create analytics dashboard for internal metrics (admin view)
  - [ ] Write tests for analytics event capture and aggregation

- [ ] Task 8: Develop Churn Prediction and Retention System (AC: 8)
  - [ ] Create user_engagement_metrics table (user_id, last_login, login_frequency, feature_usage_score)
  - [ ] Build ChurnPredictionService for identifying at-risk users
  - [ ] Implement churn risk scoring algorithm (login patterns, feature usage, engagement trends)
  - [ ] Add retention intervention triggers (re-engagement emails, feature highlights)
  - [ ] Create RetentionCampaignService for automated outreach
  - [ ] Implement win-back campaigns for lapsed users
  - [ ] Add retention analytics dashboard for monitoring effectiveness
  - [ ] Test churn prediction accuracy and intervention effectiveness

- [ ] Task 9: Create Unified Engagement Dashboard (AC: 1-8)
  - [ ] Build UserEngagementDashboard component showing all metrics
  - [ ] Add onboarding progress indicator
  - [ ] Display watchlist summary and recent changes
  - [ ] Show achievement progress and next milestones
  - [ ] Add referral stats and rewards earned
  - [ ] Implement quick feedback widget
  - [ ] Create personalized engagement suggestions
  - [ ] Test dashboard performance with real user data

- [ ] Task 10: Integration and Testing (AC: All)
  - [ ] Integrate all engagement features with existing user profile
  - [ ] Add engagement metrics to user API responses
  - [ ] Implement database migrations for all new tables
  - [ ] Write comprehensive integration tests for engagement workflows
  - [ ] Test email delivery and digest generation
  - [ ] Validate analytics tracking accuracy
  - [ ] Performance test with simulated user engagement data
  - [ ] Document all engagement features and admin capabilities

## Dev Notes

### Architecture Context

**System Overview**
[Source: technical-architecture/1-system-overview.md]
- Microservices architecture within monorepo
- FastAPI backend for API services
- Next.js 14 frontend with React 18 + TypeScript
- PostgreSQL + TimescaleDB for data storage
- Redis for caching and session management
- JWT-based authentication with 15-min access tokens

**Tech Stack References**
[Source: technical-architecture/1-system-overview.md]
- **Backend**: FastAPI (Python) for User Service endpoints
- **Frontend**: Next.js 14 with React 18, TypeScript for UI components
- **Database**: PostgreSQL for relational data, TimescaleDB for time-series analytics
- **Caching**: Redis for session cache and rankings cache
- **Authentication**: JWT tokens with subscription tier checks

### Database Design

**Existing User Schema**
[Source: technical-architecture/5-database-design.md]
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    subscription_tier VARCHAR(20) DEFAULT 'free',
    stripe_customer_id VARCHAR(50),
    fantrax_user_id VARCHAR(50),
    fantrax_refresh_token TEXT,
    preferences JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);
```

**New Tables Required for Story 4.5:**
- `watchlists` - Track user prospect watchlists with notes
- `email_preferences` - Manage digest settings and frequency
- `achievements` - Define available achievements
- `user_achievements` - Track unlocked achievements per user
- `referral_codes` - Store referral codes and usage tracking
- `referrals` - Track referral relationships and rewards
- `feedback` - Store user feedback and ratings
- `analytics_events` - Capture user interaction events
- `user_engagement_metrics` - Aggregate engagement data for churn prediction

**Indexing Strategy**
[Source: technical-architecture/5-database-design.md]
- Create indexes on user_id for all new user-relationship tables
- Add composite indexes for frequent queries (user_id + timestamp)
- Use JSONB indexes for analytics_events event_data queries

### API Layer

**Existing API Pattern**
[Source: technical-architecture/4-api-layer.md]
- Authentication endpoints: `/api/auth/*`
- User profile: `/api/users/profile`
- Caching strategy: Redis with TTL-based invalidation

**New Endpoints Required:**
- `POST /api/users/onboarding/complete` - Mark onboarding complete
- `GET/POST/DELETE /api/watchlist` - Watchlist CRUD operations
- `GET/PUT /api/users/email-preferences` - Email digest settings
- `GET /api/achievements` - List all achievements
- `GET /api/users/achievements` - User's unlocked achievements
- `POST /api/referrals/generate` - Generate referral code
- `GET /api/referrals/stats` - Referral statistics
- `POST /api/feedback` - Submit user feedback
- `POST /api/analytics/track` - Track analytics events
- `GET /api/users/engagement` - Get user engagement metrics

**API Caching Strategy**
[Source: technical-architecture/4-api-layer.md]
- Watchlist changes: No cache, real-time data
- Achievements: 1-hour TTL, invalidate on unlock
- Analytics: No cache for event submission
- Engagement metrics: 15-minute TTL for dashboards

### UX Design Context

**User Onboarding Flow**
[Source: ux-architecture/1-user-journey-flows.md#Flow-1]
```
Onboarding Sequence:
├── Welcome & Platform Overview
├── Feature Tour (Rankings, Profiles, Comparisons)
├── Subscription Tier Selection
└── Optional: Fantrax Integration Setup
```

**Success Metrics**
[Source: ux-architecture/8-success-metrics-validation.md]
- Time to first prospect evaluation: <3 minutes from registration
- User retention: >95% week-1, >80% month-1, >60% month-6
- Feature adoption: 70% use comparison tool within first week

**Behavioral Milestones**
[Source: ux-architecture/1-user-journey-flows.md#1.3]
- Day 1: Complete registration, view top 25 prospects
- Day 3: Use filtering and individual prospect profiles
- Week 1: Complete first prospect comparison
- Week 2: Establish regular research pattern (2-3 sessions)
- Month 1: Consider premium upgrade or integrate Fantrax

### Previous Story Context

**Story 4.2 Implementation Notes**
- Feature flag system implemented with tier-based access control
- Beta features use `beta_features_enabled` in user preferences
- User preferences stored in JSONB field on users table
- Frontend components use subscription tier checks for feature gating

**Story 4.4 Implementation Notes**
- User preference model includes risk tolerance settings
- Recommendation system uses stored preferences for personalization
- API endpoints follow pattern: `/api/recommendations/{category}/{league_id}`

### Email Provider Selection

**No specific guidance found in architecture docs**

For Story 4.5, the team will need to select an email service provider. Common options:
- **Resend** - Developer-friendly, simple API
- **SendGrid** - Enterprise-grade, proven reliability
- **AWS SES** - Cost-effective if already using AWS

This decision should be made during implementation based on:
- Cost per email for expected volume
- Deliverability rates
- API simplicity and documentation
- Integration with existing infrastructure

### Analytics Privacy Considerations

**Security Implementation**
[Source: technical-architecture/technical-constraints-considerations.md]
- GDPR compliance required for user data
- User data export/deletion endpoints needed
- Encryption at rest: AES-256 for sensitive data
- TLS 1.3 for all communications

**Analytics Implementation Notes:**
- Obtain user consent for analytics tracking
- Allow users to opt-out of non-essential tracking
- Anonymize analytics data where possible
- Provide transparency about data collection in privacy policy
- Implement data retention policies for analytics events

### Background Jobs and Scheduling

**No specific guidance found in architecture docs**

For weekly email digests and analytics aggregation, the team will need:
- Background task queue (e.g., Celery with Redis, APScheduler, or FastAPI Background Tasks)
- Scheduled job system for recurring tasks
- Job monitoring and failure handling

Implementation approach should:
- Use lightweight solution appropriate for solo developer timeline
- Ensure jobs can be monitored and debugged
- Handle failures gracefully with retry logic
- Support timezone-aware scheduling for user-specific send times

### Component Architecture

**Frontend Component Organization**
[Source: coding-standards.md#File-Organization]
```
apps/web/src/
├── components/
│   ├── onboarding/     # OnboardingWizard, FeatureTour
│   ├── engagement/     # AchievementBadge, ReferralDashboard
│   ├── watchlist/      # WatchlistCard, WatchlistDashboard
│   └── feedback/       # FeedbackModal, FeedbackWidget
├── hooks/
│   ├── useOnboarding.ts
│   ├── useWatchlist.ts
│   ├── useAchievements.ts
│   ├── useReferrals.ts
│   └── useAnalytics.ts
└── lib/
    └── api/
        ├── onboarding.ts
        ├── watchlist.ts
        ├── achievements.ts
        ├── referrals.ts
        ├── feedback.ts
        └── analytics.ts
```

**Backend Service Organization**
```
apps/api/app/
├── services/
│   ├── onboarding_service.py
│   ├── watchlist_service.py
│   ├── email_digest_service.py
│   ├── achievement_service.py
│   ├── referral_service.py
│   ├── feedback_service.py
│   ├── analytics_service.py
│   ├── churn_prediction_service.py
│   └── retention_campaign_service.py
├── api/api_v1/endpoints/
│   ├── onboarding.py
│   ├── watchlist.py
│   ├── achievements.py
│   ├── referrals.py
│   ├── feedback.py
│   └── analytics.py
└── schemas/
    ├── onboarding.py
    ├── watchlist.py
    ├── achievements.py
    ├── referrals.py
    ├── feedback.py
    └── analytics.py
```

### Notification System

**Notification Types Required:**
- Achievement unlocks (in-app toast/modal)
- Watchlist changes (in-app + optional email)
- Referral rewards (in-app + email)
- Retention campaigns (email)
- Weekly digest (email)

**Implementation Approach:**
- In-app notifications: WebSocket or polling for real-time updates
- Email notifications: Use selected email provider API
- Notification preferences: Stored in user preferences JSONB
- Notification history: Track sent notifications to prevent duplicates

### Performance Considerations

**Response Time Targets**
[Source: technical-architecture/technical-constraints-considerations.md]
- Database queries: <100ms for 95% of operations
- API endpoints: Standard response times apply

**Scalability Targets**
- Support 1000+ concurrent users
- Handle 150+ daily active users
- Process 100K+ API requests daily

**Optimization Strategies:**
- Cache achievement data (changes infrequently)
- Batch analytics event writes
- Async email sending to avoid blocking requests
- Efficient watchlist change detection queries
- Index all foreign key relationships

### Testing

**Testing Standards**
[Source: coding-standards.md#Testing-Standards]
- All public functions require comprehensive JSDoc comments
- Test files located in `apps/api/tests/` and `apps/web/src/__tests__/`
- Use pytest for Python backend tests
- Use Jest for TypeScript/React frontend tests

**Test Coverage Required:**
- Unit tests for all service methods
- Integration tests for API endpoints
- Component tests for UI elements
- E2E tests for critical flows (onboarding, watchlist, referral)
- Email template rendering tests
- Analytics tracking accuracy tests

**Test File Locations:**
- Backend: `apps/api/tests/services/test_<service_name>.py`
- Backend: `apps/api/tests/api/test_<endpoint_name>.py`
- Frontend: `apps/web/src/__tests__/components/<component_name>.test.tsx`
- Frontend: `apps/web/src/__tests__/hooks/<hook_name>.test.ts`

### Documentation Standards

**JSDoc/Docstring Requirements**
[Source: coding-standards.md]
- All public functions must include comprehensive documentation
- Include @param, @returns, @throws tags
- Provide usage @example for complex functions
- Document performance characteristics where relevant
- Mark @deprecated features with migration notes

**Code Quality Standards**
- TypeScript strict mode enabled
- No `any` types - use proper typing
- Explicit return types for all functions
- Maximum function length: 50 lines
- Maximum cyclomatic complexity: 10

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes

_To be populated during implementation_

### File List

_To be populated during implementation_

## QA Results

_Results from QA Agent review will be populated here after implementation_
